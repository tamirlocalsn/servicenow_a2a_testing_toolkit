<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiceNow A2A Testing - Python Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #323130;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #ffffff;
        }
        
        .header {
            background: linear-gradient(90deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: 300;
        }
        
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            position: relative;
        }
        
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 8px;
            right: 60px;
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #323130;
            color: white;
            border: 1px solid #605e5c;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #484644;
        }
        
        .copy-btn.copied {
            background: #107c10;
            border-color: #107c10;
        }
        
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #deecf9;
            border-color: #0078d4;
            color: #004578;
        }
        
        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 10px 0;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0078d4;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .download-btn:hover {
            background: #106ebe;
            text-decoration: none;
        }
        
        .download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        h1, h2, h3 {
            color: #323130;
        }
        
        h1 {
            font-size: 2.2em;
            border-bottom: 3px solid #0078d4;
            padding-bottom: 10px;
        }
        
        .inline-code {
            background: #f3f2f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #a31621;
        }
        
        /* Global Navigation Styles */
        .global-nav {
            background: #323130;
            padding: 15px 0;
            margin-bottom: 20px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav-brand {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-links a {
            color: #d4d4d4;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .nav-links a:hover {
            background: #0078d4;
            color: white;
        }
        
        .nav-links a.current {
            background: #0078d4;
            color: white;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-links {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <div class="nav-container">
            <a href="ServiceNow_A2A_Complete_Index.html" class="nav-brand">üè† ServiceNow A2A Testing Toolkit</a>
            <div class="nav-links">
                <a href="ServiceNow_A2A_Complete_Index.html">üè† Home</a>
                <a href="ServiceNow_A2A_Overview.html">üìã Overview</a>
                <a href="ServiceNow_A2A_Python_Client.html" class="current">üêç Python Client</a>
                <a href="ServiceNow_A2A_Bash_Scripts.html">üìú Bash Scripts</a>
                <a href="ServiceNow_A2A_Examples.html">üí° Examples</a>
                <a href="ServiceNow_A2A_Troubleshooting.html">üîß Troubleshooting</a>
            </div>
        </div>
    </nav>

    <div class="header">
        <h1>ServiceNow A2A Testing</h1>
        <p>Python Client Guide</p>
    </div>
        </div>
        
        
        <section>
            <h1>üêç Python A2A Client</h1>
            
            <p>The Python client provides a robust interface for ServiceNow A2A integration. It handles authentication, agent discovery, message sending, and conversation context automatically.</p>
            
            <div class="script-header">
                <h2>Script</h2>
                <a href="generic_a2a_client.py" download class="download-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Python Client
                </a>
            </div>
            
            <h3>Running the Client</h3>
            <p>To run the client, execute the following command in your terminal:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python generic_a2a_client.py</code></pre>
            </div>

            <p>Or if you need to use a specific Python version:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python3.12 generic_a2a_client.py</code></pre>
            </div>

            <p>The script will automatically load your credentials from the <code>.env</code> file and attempt to connect to your ServiceNow instance.</p>

            <h2>Python Client for ServiceNow A2A</h2>

            <div class="alert alert-info">
                <strong>Prerequisites:</strong>
                <ul>
                    <li>Python 3.12 or higher</li>
                    <li>Required packages: <code>httpx</code>, <code>python-dotenv</code>, <code>a2a-sdk</code></li>
                    <li>ServiceNow instance with A2A agent configured</li>
                    <li>Valid API key with appropriate permissions</li>
                </ul>
            </div>

            <h3>Installation and Setup</h3>
            <p>1. Ensure you have Python 3.12 or newer installed. You can check your Python version with:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python --version  # Should show Python 3.12.x or higher</code></pre>
            </div>

            <p>2. Install the required Python packages:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>pip install httpx python-dotenv a2a-sdk</code></pre>
            </div>

            <p>3. Create a new file named <code>generic_a2a_client.py</code> and paste the downloaded code into it, or use the downloaded file directly.</p>

            <p>4. Create a <code>.env</code> file in the same directory as the script with your credentials:</p>
            <div class="code-block" data-lang="env">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>SERVICENOW_INSTANCE=your-instance.service-now.com
SERVICENOW_AGENT_ID=your_agent_id_here
SERVICENOW_TOKEN=your_api_token_here</code></pre>
            </div>
        </section>
        
        <section>
            <h1>üìù Complete Source Code</h1>
            
            <p>Save this as <span class="inline-code">generic_a2a_client.py</span>:</p>
            
            <div class="code-block" data-lang="python">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>#!/usr/bin/env python3
"""
ServiceNow A2A Client

A client for connecting to ServiceNow Agent-to-Agent (A2A) endpoints.
Supports environment variables and direct configuration.

Usage:
    # Using environment variables
    # Create a .env file with:
    # SERVICENOW_INSTANCE=your-instance.service-now.com
    # SERVICENOW_AGENT_ID=your-agent-id
    # SERVICENOW_TOKEN=your-api-key
    
    # Run the client
    python generic_a2a_client.py
"""

import asyncio
import os
import json
import logging
import httpx
from uuid import uuid4
from typing import Dict, Any, Optional
from dataclasses import dataclass
from pathlib import Path
from dotenv import load_dotenv
from a2a.client import A2AClient
from a2a.types import AgentCard, Message, SendMessageRequest, MessageSendParams

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Load environment variables from .env file
def load_environment():
    # Look for .env file in current directory and parent directories
    current_dir = Path(__file__).parent.absolute()
    env_path = None
    
    # Check current directory and parent directories
    for path in [current_dir, current_dir.parent]:
        env_file = path / '.env'
        if env_file.exists():
            env_path = env_file
            break
    
    if env_path:
        logger.info(f"Loading environment from: {env_path}")
        load_dotenv(env_path)
    else:
        logger.warning("No .env file found in current or parent directories")

# Load environment variables
load_environment()

@dataclass
class ServiceNowConfig:
    """Configuration for ServiceNow A2A client"""
    instance: str  # e.g., "your-instance.service-now.com"
    agent_id: str  # ServiceNow agent ID
    api_key: str   # ServiceNow API key
    
    @classmethod
    def from_env(cls) -> 'ServiceNowConfig':
        """Create configuration from environment variables"""
        instance = os.getenv("SERVICENOW_INSTANCE")
        agent_id = os.getenv("SERVICENOW_AGENT_ID")
        api_key = os.getenv("SERVICENOW_TOKEN")
        
        if not all([instance, agent_id, api_key]):
            raise ValueError(
                "Missing required environment variables. Please set:\n"
                "- SERVICENOW_INSTANCE\n"
                "- SERVICENOW_AGENT_ID\n"
                "- SERVICENOW_TOKEN"
            )
            
        return cls(instance=instance, agent_id=agent_id, api_key=api_key)

class ServiceNowA2AClient:
    """ServiceNow A2A Client"""
    
    def __init__(self, instance: str = None, agent_id: str = None, api_key: str = None):
        """
        Initialize the ServiceNow A2A client
        
        Args:
            instance: ServiceNow instance (e.g., "your-instance.service-now.com")
            agent_id: ServiceNow agent ID
            api_key: ServiceNow API key
        """
        # Load from parameters or environment variables
        self.config = ServiceNowConfig(
            instance=instance or os.getenv("SERVICENOW_INSTANCE"),
            agent_id=agent_id or os.getenv("SERVICENOW_AGENT_ID"),
            api_key=api_key or os.getenv("SERVICENOW_TOKEN")
        )
        
        # Log the configuration (without exposing the full API key)
        logger.info(f"Configuration loaded - Instance: {self.config.instance}, Agent ID: {self.config.agent_id}")
        
        if not all([self.config.instance, self.config.agent_id, self.config.api_key]):
            raise ValueError(
                "Missing required configuration. Please provide:\n"
                "- SERVICENOW_INSTANCE\n"
                "- SERVICENOW_AGENT_ID\n"
                "- SERVICENOW_TOKEN\n"
                "Either pass these as parameters or set them in the .env file."
            )

        # Initialize HTTP client settings
        self.timeout = httpx.Timeout(30.0, connect=10.0)
        self.agent_card_url = f"https://{self.config.instance}/api/sn_aia/a2a/id/{self.config.agent_id}/well_known/agent_json"
        
    async def _get_agent_card(self, client: httpx.AsyncClient) -> AgentCard:
        """Fetch the agent card from ServiceNow."""
        try:
            headers = {
                'content-type': 'application/json',
                'x-sn-apikey': self.config.api_key,
                'user-agent': 'python-a2a-client/1.0'
            }
            
            logger.info(f"Fetching agent card from: {self.agent_card_url}")
            response = await client.get(self.agent_card_url, headers=headers)
            response.raise_for_status()
            
            agent_card_data = response.json()
            agent_card = AgentCard(**agent_card_data)
            
            logger.info(f"Agent card loaded: {agent_card.name}")
            logger.debug(f"Agent details: {agent_card}")
            
            return agent_card
        except Exception as e:
            logger.error(f"Failed to fetch agent card: {str(e)}")
            raise

    async def send_message(self, message: str) -> Dict[str, Any]:
        """
        Send a message to the ServiceNow agent
        
        Args:
            message: The message text to send
            
        Returns:
            Dict containing the response from the agent
        """
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            try:
                # Get the agent card
                agent_card = await self._get_agent_card(client)
                
                # Initialize A2A client
                a2a_client = A2AClient(
                    httpx_client=client,
                    agent_card=agent_card
                )
                
                # Create message body
                request_id = uuid4().hex
                message_body = {
                    'message': {
                        'role': 'user',
                        'parts': [{'kind': 'text', 'text': message}],
                        'messageId': uuid4().hex,
                        'kind': 'message'
                    },
                    'context': {
                        'contextId': None,
                        'taskId': None
                    },
                    'metadata': {},
                    'pushNotificationUrl': f"http://localhost:8080/a2a/callback/{self.config.agent_id}/{request_id}",
                    'id': request_id
                }
                
                # Create and send the request
                request = SendMessageRequest(
                    id=str(uuid4()),
                    params=MessageSendParams(**message_body)
                )
                
                logger.info(f"Sending message: {message}")
                response = await a2a_client.send_message(request)
                
                # Convert response to dict if needed
                if hasattr(response, 'model_dump'):
                    return response.model_dump(mode='json', exclude_none=True)
                return dict(response) if hasattr(response, '__dict__') else str(response)
                
            except Exception as e:
                logger.error(f"Error sending message: {str(e)}", exc_info=True)
                return {
                    "error": str(e),
                    "error_type": type(e).__name__,
                    "config": {
                        "instance": self.config.instance,
                        "agent_id": self.config.agent_id,
                        "api_key": f"{self.config.api_key[:5]}..." if self.config.api_key else None
                    }
                }
        Args:
            message_text: The message to send to the agent
            context_id: Optional context ID for conversation continuity
            task_id: Optional task ID for task tracking
        """
        request_id = uuid4().hex
        message_id = uuid4().hex
        
        message_body = {
            'message': {
                'role': 'user',
                'parts': [
                    {'kind': 'text', 'text': message_text}
                ],
                'messageId': message_id,
                'kind': 'message'  # SDK expects 'message'
            },
            'context': {
                'contextId': context_id,
                'taskId': task_id
            },
            'metadata': {},
            'pushNotificationUrl': f"http://localhost:8080/a2a/callback/{self.config.agent_id}/{request_id}",
            'id': request_id
        }

        return message_body

    async def send_message(self, message_text: str, context_id: str = None, task_id: str = None) -> Dict[str, Any]:
        """
        Send a message to the ServiceNow agent
        
        Args:
            message_text: The message to send
            context_id: Optional context ID for conversation continuity
            task_id: Optional task ID for task tracking
            
        Returns:
            The agent's response as a dictionary
        """
        if not self.a2a_client:
            raise RuntimeError("A2A client not initialized. Call initialize_client() first.")
        
        print(f"üí¨ Sending message: {message_text}")
        
        message_body = self.create_message_body(message_text, context_id, task_id)
        
        request = SendMessageRequest(
            id=str(uuid4()), 
            params=MessageSendParams(**message_body)
        )

        try:
            response = await self.a2a_client.send_message(request)
            print("‚úÖ Message sent successfully!")
            
            # Extract and display agent response in a user-friendly way
            if hasattr(response, 'result') and response.result:
                result = response.result
                if hasattr(result, 'status') and result.status:
                    status = result.status
                    if hasattr(status, 'message') and status.message:
                        message = status.message
                        if hasattr(message, 'parts') and message.parts:
                            print("\nü§ñ Agent Response:")
                            for part in message.parts:
                                if hasattr(part, 'text'):
                                    print(f"   {part.text}")
                            print()
            
            return response.model_dump(mode='json', exclude_none=True)
            
        except Exception as e:
            print(f"‚ùå Error sending message: {e}")
            raise

    async def connect_and_send(self, message_text: str, context_id: str = None, task_id: str = None) -> Dict[str, Any]:
        """
        Convenience method to connect to agent and send a message in one call
        
        Args:
            message_text: The message to send
            context_id: Optional context ID for conversation continuity
            task_id: Optional task ID for task tracking
            
        Returns:
            The agent's response as a dictionary
        """
        timeout = httpx.Timeout(30.0, connect=10.0)
        
        async with httpx.AsyncClient(timeout=timeout) as httpx_client:
            await self.fetch_agent_card(httpx_client)
            self.initialize_client(httpx_client)
            return await self.send_message(message_text, context_id, task_id)


async def main():
    """Example usage of the ServiceNow A2A client"""
    print("=== ServiceNow A2A Client ===")
    
    try:
        # Initialize client with environment variables from .env
        client = ServiceNowA2AClient()
        
        # Test message
        test_message = "What can you help me with?"
        print(f"Sending test message: {test_message}")
        
        # Send message and get response
        response = await client.send_message(test_message)
        
        # Print the response
        print("\n=== Agent Response ===")
        print(json.dumps(response, indent=2))
        print("=====================")
        
        print(f"üè¢ Instance: {client.config.instance}")
        print(f"ü§ñ Agent ID: {client.config.agent_id}")
        print(f"üîë API Key: {client.config.api_key[:15]}...")
        
        # Send a message to the agent
        message = "What can you help me with?"
        response = await client.connect_and_send(message)
        
        print("\n‚úÖ A2A Client completed successfully!")
        
    except ValueError as e:
        print(f"‚ùå Configuration Error: {e}")
        print("\nRequired environment variables:")
        print("  SERVICENOW_INSTANCE=your-instance.service-now.com")
        print("  SERVICENOW_AGENT_ID=your-agent-id")
        print("  SERVICENOW_TOKEN=your-api-key")
        
    except Exception as e:
        print(f"‚ùå A2A Client failed: {e}")
        print(f"Error type: {type(e).__name__}")


if __name__ == "__main__":
    asyncio.run(main())</pre>
        </div>
    </section>
    
    <section>
        <h1>üí° Usage Examples</h1>
        
        <h2>Basic Usage</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>import asyncio
from generic_a2a_client import ServiceNowA2AClient

async def main():
    client = ServiceNowA2AClient()
    response = await client.connect_and_send("What can you help me with?")
    print(response)

asyncio.run(main())</div>
        
        <h2>Direct Configuration</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>client = ServiceNowA2AClient(
    instance="your-instance.service-now.com",
    agent_id="your-agent-id",
    api_key="your-api-key"
)

response = await client.connect_and_send("How can you assist me?")</pre>
        </div>
        
        <h2>Conversation with Context</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>async def conversation_example():
    client = ServiceNowA2AClient()
    
    # First message
    response1 = await client.connect_and_send("What topics do you cover?")
    
    # Extract context for follow-up
    context_id = response1.get('result', {}).get('contextId')
    
    # Follow-up message with context
    response2 = await client.connect_and_send(
        "Tell me more about the first topic",
        context_id=context_id
    )
    
    return response1, response2</pre>
        </div>
    </section>
    
    <div class="nav-links">
        <strong>Next:</strong> <a href="ServiceNow_A2A_Bash_Scripts.html">Bash Scripts Guide ‚Üí</a>
    </div>

    <script>
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                button.textContent = 'Error';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }
    </script>
</body>
</html>
