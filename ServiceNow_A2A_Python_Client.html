<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiceNow A2A Testing - Python Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #323130;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #ffffff;
        }
        
        .header {
            background: linear-gradient(90deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: 300;
        }
        
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            position: relative;
        }
        
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 8px;
            right: 60px;
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #323130;
            color: white;
            border: 1px solid #605e5c;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #484644;
        }
        
        .copy-btn.copied {
            background: #107c10;
            border-color: #107c10;
        }
        
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #deecf9;
            border-color: #0078d4;
            color: #004578;
        }
        
        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 10px 0;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0078d4;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .download-btn:hover {
            background: #106ebe;
            text-decoration: none;
        }
        
        .download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        h1, h2, h3 {
            color: #323130;
        }
        
        h1 {
            font-size: 2.2em;
            border-bottom: 3px solid #0078d4;
            padding-bottom: 10px;
        }
        
        .inline-code {
            background: #f3f2f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #a31621;
        }
        
        /* Global Navigation Styles */
        .global-nav {
            background: #323130;
            padding: 15px 0;
            margin-bottom: 20px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav-brand {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-links a {
            color: #d4d4d4;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .nav-links a:hover {
            background: #0078d4;
            color: white;
        }
        
        .nav-links a.current {
            background: #0078d4;
            color: white;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-links {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <div class="nav-container">
            <a href="ServiceNow_A2A_Complete_Index.html" class="nav-brand">üè† ServiceNow A2A Testing Toolkit</a>
            <div class="nav-links">
                <a href="ServiceNow_A2A_Complete_Index.html">üè† Home</a>
                <a href="ServiceNow_A2A_Overview.html">üìã Overview</a>
                <a href="ServiceNow_A2A_Python_Client.html" class="current">üêç Python Client</a>
                <a href="ServiceNow_A2A_Bash_Scripts.html">üìú Bash Scripts</a>
                <a href="ServiceNow_A2A_Examples.html">üí° Examples</a>
                <a href="ServiceNow_A2A_Troubleshooting.html">üîß Troubleshooting</a>
            </div>
        </div>
    </nav>

    <div class="header">
        <h1>ServiceNow A2A Testing</h1>
        <p>Python Client Guide</p>
    </div>
        </div>
        
        
        <section>
            <h1>üêç Python A2A Client</h1>
            
            <p>The Python client provides a robust interface for ServiceNow A2A integration. It handles authentication, agent discovery, message sending, and conversation context automatically.</p>
            
            <div class="script-header">
                <h2>Script</h2>
                <a href="generic_a2a_client.py" download class="download-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Python Client
                </a>
            </div>
            
            <h3>Complete Source Code</h3>
            <p>Here's the complete source code for the Python client. You can also download it using the button above.</p>
            
            <div class="code-block" data-lang="python">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>#!/usr/bin/env python3
"""
ServiceNow A2A Client

A client for connecting to ServiceNow Agent-to-Agent (A2A) endpoints.
Supports environment variables and direct configuration.

Usage:
    # Using environment variables
    # Create a .env file with:
    # SERVICENOW_INSTANCE=your-instance.service-now.com
    # SERVICENOW_AGENT_ID=your-agent-id
    # SERVICENOW_TOKEN=your-api-key
"""

import os
import asyncio
import logging
import json
from pathlib import Path
from typing import Dict, Any, Optional
from uuid import uuid4
from dataclasses import dataclass

import httpx
from dotenv import load_dotenv
from a2a_sdk import A2AClient
from a2a_sdk.models import AgentCard, SendMessageRequest, MessageSendParams

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

@dataclass
class ServiceNowConfig:
    """Configuration for ServiceNow A2A client"""
    instance: str  # e.g., "your-instance.service-now.com"
    agent_id: str  # ServiceNow agent ID
    api_key: str   # ServiceNow API key

def load_environment():
    # Look for .env file in current directory and parent directories
    current_dir = Path(__file__).parent.absolute()
    env_path = None
    
    # Check current directory and parent directories for .env file
    for path in [current_dir, current_dir.parent]:
        env_file = path / '.env'
        if env_file.exists():
            env_path = env_file
            break
    
    if env_path:
        load_dotenv(env_path)
        logger.info(f"Loaded environment variables from {env_path}")
    else:
        logger.info("No .env file found, using environment variables")
    
    # Get required environment variables
    instance = os.getenv('SERVICENOW_INSTANCE')
    agent_id = os.getenv('SERVICENOW_AGENT_ID')
    api_key = os.getenv('SERVICENOW_TOKEN')
    
    if not all([instance, agent_id, api_key]):
        missing = []
        if not instance:
            missing.append('SERVICENOW_INSTANCE')
        if not agent_id:
            missing.append('SERVICENOW_AGENT_ID')
        if not api_key:
            missing.append('SERVICENOW_TOKEN')
        raise ValueError(f"Missing required environment variables: {', '.join(missing)}")
    
    return ServiceNowConfig(instance=instance, agent_id=agent_id, api_key=api_key)

class ServiceNowA2AClient:
    """ServiceNow A2A Client"""
    
    def __init__(self, instance: str = None, agent_id: str = None, api_key: str = None):
        """
        Initialize the ServiceNow A2A client.
        
        Args:
            instance: ServiceNow instance (e.g., 'your-instance.service-now.com')
            agent_id: ServiceNow A2A agent ID
            api_key: ServiceNow API key
        """
        if all([instance, agent_id, api_key]):
            self.config = ServiceNowConfig(instance, agent_id, api_key)
        else:
            try:
                self.config = load_environment()
            except ValueError as e:
                logger.error(f"Configuration error: {e}")
                raise
        
        self.agent_card = None
        self.a2a_client = None
        self.timeout = 30.0
        
    async def _get_agent_card(self, httpx_client: httpx.AsyncClient) -> AgentCard:
        """Fetch the agent card from ServiceNow"""
        headers = {
            'Authorization': f'Bearer {self.config.api_key}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
        
        discovery_url = f"https://{self.config.instance}/api/sn_aia/a2a/id/{self.config.agent_id}/well_known/agent_json"
        
        try:
            logger.info(f"Fetching agent card from {discovery_url}")
            response = await httpx_client.get(
                discovery_url,
                headers=headers,
                timeout=self.timeout
            )
            response.raise_for_status()
            
            agent_data = response.json()
            logger.info(f"Successfully fetched agent card: {agent_data.get('name')}")
            return AgentCard(**agent_data)
            
        except httpx.HTTPStatusError as e:
            logger.error(f"HTTP error fetching agent card: {e.response.status_code} - {e.response.text}")
            raise
        except Exception as e:
            logger.error(f"Error fetching agent card: {str(e)}")
            raise
    
    async def send_message(self, message: str) -> Dict[str, Any]:
        """
        Send a message to the ServiceNow agent
        
        Args:
            message: The message to send to the agent
            
        Returns:
            The agent's response as a dictionary
        """
        timeout = httpx.Timeout(self.timeout, connect=10.0)
        
        async with httpx.AsyncClient(timeout=timeout) as httpx_client:
            try:
                # Fetch agent card if not already fetched
                if not self.agent_card:
                    self.agent_card = await self._get_agent_card(httpx_client)
                
                # Initialize A2A client if not already initialized
                if not self.a2a_client:
                    self.a2a_client = A2AClient(
                        httpx_client=httpx_client,
                        agent_card=self.agent_card
                    )
                
                # Create message body
                message_body = {
                    'message': {
                        'role': 'user',
                        'parts': [{'kind': 'text', 'text': message}],
                        'messageId': str(uuid4()),
                        'kind': 'message'
                    },
                    'context': {
                        'contextId': str(uuid4())
                    },
                    'metadata': {},
                    'pushNotificationUrl': f"http://localhost:8080/a2a/callback/{self.config.agent_id}/{uuid4().hex}",
                    'id': str(uuid4())
                }
                
                # Create request
                request = SendMessageRequest(
                    id=str(uuid4()),
                    params=MessageSendParams(**message_body)
                )
                
                # Send message
                logger.info(f"Sending message to agent: {message}")
                response = await self.a2a_client.send_message(request)
                logger.info("Message sent successfully!")
                
                # Convert response to dict if it's a Pydantic model
                if hasattr(response, 'model_dump'):
                    return response.model_dump(mode='json')
                
                # If it's already a dict, return as is
                if isinstance(response, dict):
                    return response
                    
                # Otherwise, try to convert to dict
                try:
                    return dict(response)
                except (TypeError, ValueError):
                    return str(response)
                
            except Exception as e:
                logger.error(f"Error sending message: {str(e)}")
                return {
                    "error": str(e),
                    "error_type": type(e).__name__,
                    "config": {
                        "instance": self.config.instance,
                        "agent_id": self.config.agent_id,
                        "api_key": f"{self.config.api_key[:5]}..." if self.config.api_key else None
                    }
                }

    async def connect_and_send(self, message: str) -> Dict[str, Any]:
        """Send a message to the ServiceNow agent."""
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            try:
                # Get the agent card
                agent_card = await self._get_agent_card(client)
                
                # Initialize A2A client with additional headers
                client = httpx.AsyncClient(
                    base_url=f"https://{self.config.instance}",
                    headers={
                        'Content-Type': 'application/json',
                        'x-sn-apikey': self.config.api_key,
                        'user-agent': 'python-a2a-client/1.0'
                    },
                    timeout=self.timeout
                )
                
                # Create message body
                request_id = uuid4().hex
                message_body = {
                    "jsonrpc": "2.0",
                    "method": "message/send",
                    "id": request_id,
                    "params": {
                        "message": {
                            "role": "user",
                            "parts": [{"kind": "text", "text": message}],
                            "messageId": uuid4().hex,
                            "kind": "message"
                        },
                        "context": {
                            "contextId": None,
                            "taskId": None
                        },
                        "metadata": {},
                        "pushNotificationUrl": f"http://localhost:8080/a2a/callback/{self.config.agent_id}/{request_id}"
                    }
                }
                
                logger.info(f"Sending message: {message}")
                url = f"/api/sn_aia/a2a/v1/agent/id/{self.config.agent_id}"
                response = await client.post(url, json=message_body)
                response.raise_for_status()
                
                return response.json()
                
            except httpx.HTTPStatusError as e:
                logger.error(f"HTTP error: {e.response.status_code} - {e.response.text}")
                return {
                    "error": f"HTTP {e.response.status_code}",
                    "details": e.response.text,
                    "status_code": e.response.status_code
                }
            except Exception as e:
                logger.error(f"Error sending message: {str(e)}", exc_info=True)
                return {
                    "error": str(e),
                    "error_type": type(e).__name__,
                    "config": {
                        "instance": self.config.instance,
                        "agent_id": self.config.agent_id,
                        "api_key": f"{self.config.api_key[:5]}..." if self.config.api_key else None
                    }
                }
            finally:
                await client.aclose()

async def main():
    """Example usage of the ServiceNow A2A client"""
    print("=== ServiceNow A2A Client ===")
    
    try:
        # Initialize client with environment variables from .env
        client = ServiceNowA2AClient()
        
        # Test message
        test_message = "What can you help me with?"
        print(f"Sending test message: {test_message}")
        
        # Send message and get response
        response = await client.send_message(test_message)
        
        # Print the response
        print("\n=== Agent Response ===")
        print(json.dumps(response, indent=2))
        print("=====================")
        
    except Exception as e:
        print(f"Error: {str(e)}")
        print(f"Error type: {type(e).__name__}")
        return 1
    
    return 0

if __name__ == "__main__":
    asyncio.run(main())</pre>
            </div>
            
            <h3>Running the Client</h3>
            <p>To run the client, execute the following command in your terminal:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python generic_a2a_client.py</code></pre>
            </div>

            <p>Or if you need to use a specific Python version:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python3.12 generic_a2a_client.py</code></pre>
            </div>

            <p>The script will automatically load your credentials from the <code>.env</code> file and attempt to connect to your ServiceNow instance.</p>

            <div class="alert alert-info">
                <strong>Note on Agent Types:</strong>
                <ul>
                    <li>This client is designed to work with <strong>synchronous</strong> ServiceNow A2A agents.</li>
                    <li>If you're testing with an <strong>asynchronous</strong> agent, you'll receive an error: <code>"Push Notification URL is required for asynchronous requests"</code>.</li>
                    <li>For async agents, you'll need to implement a webhook endpoint to receive the response, as they don't return results immediately.</li>
                </ul>
            </div>

            <h2>Python Client for ServiceNow A2A</h2>

            <div class="alert alert-info">
                <strong>Prerequisites:</strong>
                <ul>
                    <li>Python 3.12 or higher</li>
                    <li>Required packages: <code>httpx</code>, <code>python-dotenv</code>, <code>a2a-sdk</code></li>
                    <li>ServiceNow instance with A2A agent configured</li>
                    <li>Valid API key with appropriate permissions</li>
                </ul>
            </div>

            <h3>Installation and Setup</h3>
            <p>1. Ensure you have Python 3.12 or newer installed. You can check your Python version with:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python --version  # Should show Python 3.12.x or higher</code></pre>
            </div>

            <p>2. Install the required Python packages:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>pip install httpx python-dotenv a2a-sdk</code></pre>
            </div>

            <p>3. Create a new file named <code>generic_a2a_client.py</code> and paste the downloaded code into it, or use the downloaded file directly.</p>

            <p>4. Create a <code>.env</code> file in the same directory as the script with your credentials:</p>
            <div class="code-block" data-lang="env">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>SERVICENOW_INSTANCE=your-instance.service-now.com
SERVICENOW_AGENT_ID=your_agent_id_here
SERVICENOW_TOKEN=your_api_token_here</code></pre>
            </div>
        </section>
        
        <section>
            <h2>Running the Client</h2>
            <p>After setting up the environment variables, you can run the client with:</p>
            <div class="code-block" data-lang="bash">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>python generic_a2a_client.py</code></pre>
            </div>
            
            <h3>Example Usage</h3>
            <p>Here's how you can use the client in your Python code:</p>
            <div class="code-block" data-lang="python">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre><code>import asyncio
from generic_a2a_client import ServiceNowA2AClient

async def main():
    # Initialize the client (uses environment variables from .env)
    client = ServiceNowA2AClient()
    
    # Send a test message
    response = await client.connect_and_send("What can you help me with?")
    print("Agent response:", response)

if __name__ == "__main__":
    asyncio.run(main())</code></pre>
            </div>
            
            <h3>Troubleshooting</h3>
            <p>If you encounter any issues:</p>
            <ul>
                <li>Verify your <code>.env</code> file contains all required variables</li>
                <li>Check that your ServiceNow instance URL is correct and accessible</li>
                <li>Ensure your API key has the necessary permissions</li>
                <li>Run with debug logging for more detailed error information</li>
            </ul>
        </section>
    
    <section>
        <h1>üí° Usage Examples</h1>
        
        <h2>Basic Usage</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>import asyncio
from generic_a2a_client import ServiceNowA2AClient

async def main():
    client = ServiceNowA2AClient()
    response = await client.connect_and_send("What can you help me with?")
    print(response)

asyncio.run(main())</div>
        
        <h2>Direct Configuration</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>client = ServiceNowA2AClient(
    instance="your-instance.service-now.com",
    agent_id="your-agent-id",
    api_key="your-api-key"
)

response = await client.connect_and_send("How can you assist me?")</pre>
        </div>
        
        <h2>Conversation with Context</h2>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre>async def conversation_example():
    client = ServiceNowA2AClient()
    
    # First message
    response1 = await client.connect_and_send("What topics do you cover?")
    
    # Extract context for follow-up
    context_id = response1.get('result', {}).get('contextId')
    
    # Follow-up message with context
    response2 = await client.connect_and_send(
        "Tell me more about the first topic",
        context_id=context_id
    )
    
    return response1, response2</pre>
        </div>
    </section>
    
    <div class="nav-links">
        <strong>Next:</strong> <a href="ServiceNow_A2A_Bash_Scripts.html">Bash Scripts Guide ‚Üí</a>
    </div>

    <script>
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                button.textContent = 'Error';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }
    </script>
</body>
</html>
