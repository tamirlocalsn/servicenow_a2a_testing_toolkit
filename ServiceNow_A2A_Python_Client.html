<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiceNow A2A Testing - Python Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #323130;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #ffffff;
        }
        
        .header {
            background: linear-gradient(90deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: 300;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            position: relative;
        }
        
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 8px;
            right: 60px;
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #323130;
            color: white;
            border: 1px solid #605e5c;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #484644;
        }
        
        .copy-btn.copied {
            background: #107c10;
            border-color: #107c10;
        }
        
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #deecf9;
            border-color: #0078d4;
            color: #004578;
        }
        
        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 10px 0;
        }
        
        .download-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: background 0.3s;
        }
        
        .download-btn:hover {
            background: #106ebe;
        }
        
        .download-btn i {
            margin-right: 8px;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .nav-links {
            margin: 30px 0;
            padding: 20px;
            background: #f3f2f1;
            border-radius: 8px;
            text-align: center;
        }
        
        .nav-links a {
            color: #0078d4;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <div class="nav-container">
            <div class="nav-logo">ServiceNow A2A Testing Toolkit</div>
            <div class="nav-links">
                <a href="index.html">Home</a> | 
                <a href="ServiceNow_A2A_Python_Client.html" class="active">Python Client</a> | 
                <a href="ServiceNow_A2A_Bash_Scripts.html">Bash Scripts</a>
            </div>
        </div>
    </nav>

    <div class="header">
        <h1>ServiceNow A2A Python Client</h1>
        <p>A Python client for testing ServiceNow's Agent-to-Agent (A2A) integration</p>
    </div>

    <section>
        <h2>ðŸ“¥ Download</h2>
        <p>Download the latest version of the Python client script:</p>
        <a href="generic_a2a_client.py" class="download-btn" download>
            <i>â†“</i> Download Python Client
        </a>

        <h3>Complete Source Code</h3>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>#!/usr/bin/env python3
"""
ServiceNow A2A Client

A client for connecting to ServiceNow Agent-to-Agent (A2A) endpoints.
Supports environment variables and direct configuration.

Usage:
    # Using environment variables
    # Create a .env file with:
    # SERVICENOW_INSTANCE=your-instance.service-now.com
    # SERVICENOW_AGENT_ID=your-agent-id
    # SERVICENOW_TOKEN=your-api-key
    
    # Run the client
    python generic_a2a_client.py
"""

import asyncio
import os
import json
import logging
import httpx
from uuid import uuid4
from typing import Dict, Any, Optional
from dataclasses import dataclass
from pathlib import Path
from dotenv import load_dotenv

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Load environment variables from .env file
def load_environment():
    # Look for .env file in current directory and parent directories
    current_dir = Path(__file__).parent.absolute()
    env_path = None
    
    # Check current directory and parent directories
    for path in [current_dir, current_dir.parent]:
        env_file = path / '.env'
        if env_file.exists():
            env_path = env_file
            break
    
    if env_path:
        logger.info(f"Loading environment from: {env_path}")
        load_dotenv(env_path)
    else:
        logger.warning("No .env file found in current or parent directories")

# Load environment variables
load_environment()

@dataclass
class ServiceNowConfig:
    """Configuration for ServiceNow A2A client"""
    instance: str  # e.g., "your-instance.service-now.com"
    agent_id: str  # ServiceNow agent ID
    api_key: str   # ServiceNow API key
    
    @classmethod
    def from_env(cls) -> 'ServiceNowConfig':
        """Create configuration from environment variables"""
        instance = os.getenv("SERVICENOW_INSTANCE")
        agent_id = os.getenv("SERVICENOW_AGENT_ID")
        api_key = os.getenv("SERVICENOW_TOKEN")
        
        if not all([instance, agent_id, api_key]):
            raise ValueError(
                "Missing required environment variables. Please set:\n"
                "- SERVICENOW_INSTANCE\n"
                "- SERVICENOW_AGENT_ID\n"
                "- SERVICENOW_TOKEN"
            )
            
        return cls(instance=instance, agent_id=agent_id, api_key=api_key)

class ServiceNowA2AClient:
    """ServiceNow A2A Client"""
    
    def __init__(self, instance: str = None, agent_id: str = None, api_key: str = None):
        """
        Initialize the ServiceNow A2A client
        
        Args:
            instance: ServiceNow instance (e.g., "your-instance.service-now.com")
            agent_id: ServiceNow agent ID
            api_key: ServiceNow API key
        """
        # Load from parameters or environment variables
        self.config = ServiceNowConfig(
            instance=instance or os.getenv("SERVICENOW_INSTANCE"),
            agent_id=agent_id or os.getenv("SERVICENOW_AGENT_ID"),
            api_key=api_key or os.getenv("SERVICENOW_TOKEN")
        )
        
        # Log the configuration (without exposing the full API key)
        logger.info(f"Configuration loaded - Instance: {self.config.instance}, Agent ID: {self.config.agent_id}")
        
        if not all([self.config.instance, self.config.agent_id, self.config.api_key]):
            raise ValueError(
                "Missing required configuration. Please provide:\n"
                "- SERVICENOW_INSTANCE\n"
                "- SERVICENOW_AGENT_ID\n"
                "- SERVICENOW_TOKEN\n"
                "Either pass these as parameters or set them in the .env file."
            )
    
        # Initialize HTTP client settings
        self.timeout = 30.0
    
    async def _get_agent_card(self, client: httpx.AsyncClient) -> Dict[str, Any]:
        """Fetch the agent card from ServiceNow"""
        headers = {
            'Authorization': f'Bearer {self.config.api_key}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
        
        discovery_url = f"https://{self.config.instance}/api/sn_aia/a2a/id/{self.config.agent_id}/well_known/agent_json"
        
        try:
            logger.info(f"Fetching agent card from {discovery_url}")
            response = await client.get(
                discovery_url,
                headers=headers,
                timeout=self.timeout
            )
            response.raise_for_status()
            
            agent_data = response.json()
            logger.info(f"Successfully fetched agent card: {agent_data.get('name')}")
            return agent_data
            
        except httpx.HTTPStatusError as e:
            logger.error(f"HTTP error fetching agent card: {e.response.status_code} - {e.response.text}")
            raise
        except Exception as e:
            logger.error(f"Error fetching agent card: {str(e)}")
            raise
    
    async def send_message(self, message: str) -> Dict[str, Any]:
        """
        Send a message to the ServiceNow agent
        
        Args:
            message: The message to send to the agent
            
        Returns:
            The agent's response as a dictionary
        """
        return await self.connect_and_send(message)
    
    async def connect_and_send(self, message: str) -> Dict[str, Any]:
        """Send a message to the ServiceNow agent."""
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            try:
                # Get the agent card
                agent_card = await self._get_agent_card(client)
                
                # Initialize A2A client with additional headers
                client = httpx.AsyncClient(
                    base_url=f"https://{self.config.instance}",
                    headers={
                        'Content-Type': 'application/json',
                        'x-sn-apikey': self.config.api_key,
                        'user-agent': 'python-a2a-client/1.0'
                    },
                    timeout=self.timeout
                )
                
                # Create message body
                request_id = uuid4().hex
                message_body = {
                    "jsonrpc": "2.0",
                    "method": "message/send",
                    "id": request_id,
                    "params": {
                        "message": {
                            "role": "user",
                            "parts": [{"kind": "text", "text": message}],
                            "messageId": uuid4().hex,
                            "kind": "message"
                        },
                        "context": {
                            "contextId": None,
                            "taskId": None
                        },
                        "metadata": {},
                        "pushNotificationUrl": f"http://localhost:8080/a2a/callback/{self.config.agent_id}/{request_id}"
                    }
                }
                
                logger.info(f"Sending message: {message}")
                url = f"/api/sn_aia/a2a/v1/agent/id/{self.config.agent_id}"
                response = await client.post(url, json=message_body)
                response.raise_for_status()
                
                return response.json()
                
            except httpx.HTTPStatusError as e:
                logger.error(f"HTTP error: {e.response.status_code} - {e.response.text}")
                return {
                    "error": f"HTTP {e.response.status_code}",
                    "details": e.response.text,
                    "status_code": e.response.status_code
                }
            except Exception as e:
                logger.error(f"Error sending message: {str(e)}", exc_info=True)
                return {
                    "error": str(e),
                    "error_type": type(e).__name__,
                    "config": {
                        "instance": self.config.instance,
                        "agent_id": self.config.agent_id,
                        "api_key": f"{self.config.api_key[:5]}..." if self.config.api_key else None
                    }
                }
            finally:
                await client.aclose()

async def main():
    """Example usage of the ServiceNow A2A client"""
    print("=== ServiceNow A2A Client ===")
    
    try:
        # Initialize client with environment variables from .env
        client = ServiceNowA2AClient()
        
        # Test message
        test_message = "What can you help me with?"
        print(f"Sending test message: {test_message}")
        
        # Send message and get response
        response = await client.send_message(test_message)
        
        # Print the response
        print("\n=== Agent Response ===")
        print(json.dumps(response, indent=2))
        print("=====================")
        
    except Exception as e:
        print(f"Error: {str(e)}")
        print(f"Error type: {type(e).__name__}")
        return 1
    
    return 0

if __name__ == "__main__":
    asyncio.run(main())</code></pre>
        </div>

        <h2>Installation and Setup</h2>
        <p>1. Ensure you have Python 3.12 or newer installed. You can check your Python version with:</p>
        <div class="code-block" data-lang="bash">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>python --version  # Should show Python 3.12.x or higher</code></pre>
        </div>

        <p>2. Install the required Python packages:</p>
        <div class="code-block" data-lang="bash">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>pip install httpx python-dotenv</code></pre>
        </div>

        <p>3. Create a new file named <code>generic_a2a_client.py</code> and paste the downloaded code into it, or use the downloaded file directly.</p>

        <p>4. Create a <code>.env</code> file in the same directory as the script with your credentials:</p>
        <div class="code-block" data-lang="env">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>SERVICENOW_INSTANCE=your-instance.service-now.com
SERVICENOW_AGENT_ID=your_agent_id_here
SERVICENOW_TOKEN=your_api_token_here</code></pre>
        </div>

        <h2>Running the Client</h2>
        <p>After setting up the environment variables, you can run the client with:</p>
        <div class="code-block" data-lang="bash">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>python generic_a2a_client.py</code></pre>
        </div>

        <h2>Example Usage</h2>
        <p>Here's how you can use the client in your Python code:</p>
        <div class="code-block" data-lang="python">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code>import asyncio
from generic_a2a_client import ServiceNowA2AClient

async def main():
    # Initialize the client (uses environment variables from .env)
    client = ServiceNowA2AClient()
    
    # Send a test message
    response = await client.connect_and_send("What can you help me with?")
    print("Agent response:", response)

if __name__ == "__main__":
    asyncio.run(main())</code></pre>
        </div>

        <h2>Troubleshooting</h2>
        <p>If you encounter any issues:</p>
        <ul>
            <li>Verify your <code>.env</code> file contains all required variables</li>
            <li>Check that your ServiceNow instance URL is correct and accessible</li>
            <li>Ensure your API key has the necessary permissions</li>
            <li>Run with debug logging for more detailed error information</li>
        </ul>

        <div class="alert alert-info">
            <strong>Note:</strong> This client requires a synchronous ServiceNow A2A agent. 
            If you're using an asynchronous agent, you'll need to implement a webhook 
            endpoint to receive responses.
        </div>
    </section>

    <div class="nav-links">
        <strong>Next:</strong> <a href="ServiceNow_A2A_Bash_Scripts.html">Bash Scripts Guide â†’</a>
    </div>

    <script>
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                button.textContent = 'Failed to copy';
                button.classList.add('error');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('error');
                }, 2000);
            });
        }
    </script>
</body>
</html>
